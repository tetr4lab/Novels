@inherits ItemListBase<Book>

@page "/"

@inject NavigationManager NavigationManager

<PageTitle>Novels Home</PageTitle>

@if (DataSet.IsUnavailable) {
    <MudAlert Severity="Severity.Error" Elevation="3">Unable to connect to any of the specified database management hosts.</MudAlert>
} else if (!DataSet.IsReady || items is null) {
    <MudProgressCircular Indeterminate="true" />
} else if (items.Count > 0) {
    <style>
        th.mud-table-cell, td.mud-table-cell {
            padding-inline: 0.1em !important;
        }
    </style>
    <MudTable Items="items" Dense Breakpoint="Breakpoint.Xs" @ref="_table"
    Filter="new Func<Book, bool> (FilterFunc)"
    SortLabel="⇅"
    AllowUnsorted="true"
    @bind-SelectedItem="selectedItem"
    @bind-CurrentPage="CurrentPage"
    FooterClass="mud-background-gray"
    Hover="true"
    OnRowClick="EventCallback.Factory.Create<TableRowClickEventArgs<Book>> (this, OnRowClick)"
    Striped="true"
    ReadOnly="false">
        <HeaderContent>
            <MudTh>@(Book.Label [nameof (Book.Id)])</MudTh>
            <MudTh Class="align-middle text-nowrap">
                @(Book.Label [nameof (Book.Released)])
                @(Book.Label [nameof (Book.Readed)])
                @(Book.Label [nameof (Book.Wish)])
            </MudTh>
            <MudTh>
                <MudStack Row Spacing="0" Class="align-center">
                    <MudIcon Icon="" />
                    <MudIcon Icon="" />
                    <MudText Typo="Typo.inherit">@(Book.Label [nameof (Book.Title)])</MudText>
                </MudStack>
            </MudTh>
            <MudTh>@(Book.Label [nameof (Book.Author)])</MudTh>
            <MudTh Class="align-middle text-nowrap">@(Book.Label [nameof (Book.Site)])</MudTh>
            <MudTh Class="align-middle text-nowrap">@(Book.Label [nameof (Book.Status)])</MudTh>
            <MudTh Class="align-middle text-nowrap">@(Book.Label [nameof (Book.NumberOfSheets)])</MudTh>
            <MudTh>@(Book.Label [nameof (Book.Remarks)])</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="@(Book.Label[nameof(Book.Id)])" Class="align-right text-nowrap">
                <MudStack Row Spacing="0" Class="align-center">
                    @if (context.Id == CurrentBookId) {
                        <MudTooltip Text="@($"着目中の{Book.TableLabel}")" Arrow Duration="1000">
                            <MudIcon Icon="@Icons.Material.Filled.DoubleArrow" />
                        </MudTooltip>
                    }
                    <MudSpacer />
                    @(context.Id)
                </MudStack>
            </MudTd>
            <MudTd DataLabel="@($"{Book.Label[nameof(Book.Released)]} {Book.Label[nameof(Book.Readed)]} {Book.Label[nameof(Book.Wish)]}")" Class="align-middle text-nowrap">
                <MudIcon Icon="@(context.Released ? Icons.Material.Outlined.CheckBox : Icons.Material.Outlined.CheckBoxOutlineBlank)" />
                <MudIcon Icon="@(context.Readed ? Icons.Material.Outlined.CheckBox : Icons.Material.Outlined.CheckBoxOutlineBlank)" />
                <MudIcon Icon="@(context.Wish ? Icons.Material.Outlined.CheckBox : Icons.Material.Outlined.CheckBoxOutlineBlank)" />
            </MudTd>
            <MudTd DataLabel="@(Book.Label[nameof(Book.Title)])">
                <MudStack Row Spacing="0" Class="align-center">
                    <MudIconButton OnClick="@(() => PublishBook (context.Id))" Icon="@Icons.Material.Filled.Publish" Size="Size.Small" />
                    <MudIconButton OnClick="@(() => OpenBook (context.Id))" Icon="@Icons.Material.Filled.Book" Size="Size.Small" />
                    <MudText Typo="Typo.inherit">@(context.Title)</MudText>
                </MudStack>
            </MudTd>
            <MudTd DataLabel="@(Book.Label[nameof(Book.Author)])">
                <MudTooltip Text="@($"「{context.Author}」で絞り込み")" Arrow Duration="1000">
                    <MudLink OnClick="@(() => SetFilterText.InvokeAsync (context.Author.Replace (' ', '\u2423')))" Color="Color.Default" Typo="Typo.inherit" Underline="Underline.None">@(context.Author)</MudLink>
                </MudTooltip>
            </MudTd>
            <MudTd DataLabel="@(Book.Label[nameof(Book.Site)])" Class="align-middle text-nowrap">@(context.Site)</MudTd>
            <MudTd DataLabel="@(Book.Label[nameof(Book.Status)])" Class="align-middle text-nowrap">
                <MudChip T="string" Label="true" Size="Size.Small" Variant="Variant.Outlined" Color="@(context.StatusBgColor)" Style="width: 6em">@(context.Status)</MudChip>
            </MudTd>
            <MudTd DataLabel="@(Book.Label[nameof(Book.NumberOfSheets)])" Class="align-middle text-nowrap">
                @if (context.IsDirectContent) {
                    <MudText Typo="Typo.inherit">1/1</MudText>
                } else {
                    <MudTooltip Arrow Duration="1000">
                        <ChildContent>
                            <MudStack Row Spacing="0">
                                <MudText Typo="Typo.inherit" Color="@(
                                            (context.NumberOfPublished ?? 0) > context.NumberOfRelatedSheets || context.NumberOfRelatedSheets > (context.NumberOfSheets ?? 0) ? Color.Error :
                                            (context.NumberOfPublished ?? 0) < context.NumberOfRelatedSheets || context.NumberOfRelatedSheets < (context.NumberOfSheets ?? 0) ? Color.Warning : Color.Inherit
                                        )">
                                    @(context.NumberOfRelatedSheets)
                                </MudText>
                                <MudText Typo="Typo.inherit">
                                    /@(context.NumberOfSheets ?? 0)
                                </MudText>
                            </MudStack>
                        </ChildContent>
                        <TooltipContent>
                            <MudStack Spacing="0" Class="align-start">
                                <MudText Typo="Typo.inherit">発行数量: @(context.NumberOfPublished ?? 0)</MudText>
                                <MudText Typo="Typo.inherit">取得数量: @(context.NumberOfRelatedSheets)</MudText>
                                <MudText Typo="Typo.inherit">書誌数量: @(context.NumberOfSheets ?? 0)</MudText>
                                <MudText Typo="Typo.inherit">発行日時: @(context.PublishedAt)</MudText>
                                <MudText Typo="Typo.inherit">更新日時: @(context.LastUpdate)</MudText>
                            </MudStack>
                        </TooltipContent>
                    </MudTooltip>
                }
            </MudTd>
            <MudTd DataLabel="@(Book.Label[nameof(Book.Remarks)])">@context.Remarks</MudTd>
        </RowTemplate>
        <PagerContent>
            @if (AllowPaging) {
                <MudTablePager PageSizeOptions="_pageSizeOptions" InfoFormat="{first_item}-{last_item} / {all_items}" RowsPerPageString="行/頁:" />
            }
        </PagerContent>
    </MudTable>
} else {
    <MudText>No items found.</MudText>
}

@code {
    /// <inheritdoc/>
    protected override int _initialPageSizeIndex => 1;

    /// <summary>表示ページ</summary>
    protected int CurrentPage { get; set; } = 0;

    /// <summary>行がクリックされた</summary>
    protected async Task OnRowClick (TableRowClickEventArgs<Book> context) {
        if (context.Item is Book book) {
            selectedItem = book;
            if (CurrentBookId != book.Id) {
                await SetCurrentBookId.InvokeAsync ((book.Id, 1));
            }
        }
    }

    /// <summary>本を発行</summary>
    protected void PublishBook (long bookId) {
        NavigationManager.NavigateTo ($"{NavigationManager.BaseUri}book/{bookId}");
    }

    /// <summary>本を開く</summary>
    protected void OpenBook (long bookId) {
        NavigationManager.NavigateTo ($"{NavigationManager.BaseUri}sheets/{bookId}/{(bookId != CurrentBookId ? 1 : CurrentSheetIndex)}");
    }

    /// <summary>遅延初期化</summary>
    protected override async Task OnAfterRenderAsync (bool firstRender) {
        await base.OnAfterRenderAsync (firstRender);
        if (_inited && !_inited2 && items?.Count > 0) {
            _inited2 = true;
            if (CurrentBookId > 0) {
                // 別ページから遷移 (既存セッション)
                var item = items.FirstOrDefault (x => x.Id == CurrentBookId);
                if (item is not null) {
                    selectedItem = item;
                } else {
                    CurrentBookId = 0;
                }
            }
            if (CurrentBookId <= 0) {
                // 新規セッション または書籍が見つからない場合
                selectedItem = items [0];
                await SetCurrentBookId.InvokeAsync ((selectedItem.Id, CurrentSheetIndex));
            }
            if (_table is not null && string.IsNullOrEmpty (FilterText)) {
                // 絞り込みがなければ、選択されている書籍があるページへ
                var currentIndex = items.IndexOf (selectedItem);
                var currentPage = currentIndex / _table.RowsPerPage;
                if (currentPage != CurrentPage) {
                    CurrentPage = currentPage;
                    StateHasChanged ();
                }
            }
        }
    }
    protected bool _inited2 = false;
}

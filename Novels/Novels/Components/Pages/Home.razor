@inherits ItemListBase<Book>

@page "/"

<PageTitle>Novels Home</PageTitle>

@if (DataSet.IsUnavailable) {
    <MudAlert Severity="Severity.Error" Elevation="3">Unable to connect to any of the specified database management hosts.</MudAlert>
} else if (!DataSet.IsReady || items is null) {
    <MudProgressCircular Indeterminate="true" />
} else if (items.Count > 0) {
    <MudSimpleTable>
        @foreach (var item in items) {
            @if (FilterFunc (item)) {
                @* var urls = item.DetectedSheetUrls;
                var count = urls.Count; *@
                var updates = item.DetectedSheetUpdated;
                <tr>
                    <td>@item.Id</td>
                    <td>
                        <MudButton Size="Size.Small" Variant="Variant.Text" OnClick="async () => await SetCurrentBookId.InvokeAsync (item.Id)">
                            @(item.Id == CurrentBookId ? ">" : "　")
                        </MudButton>
                    </td>
                    @* <td>@(count != (item.NumberOfSheets ?? 0) ? $"×{count}:{item.NumberOfSheets}, {string.Join (", ", urls)}" : string.Join (", ", urls))</td> *@
                    @* <td>@item.DetectedSeriesTitle</td> *@
                    <td>@(item.Title)</td>
                    @* @{ var title = item.Title; }
                    <td>@(item.DetectedTitle != title ? "×" : "◯") @item.DetectedTitle</td> *@
                    @* <td>@(item.DetectedMainTitle != item.Title ? item.DetectedMainTitle : "")</td> *@
                    <td>@(item.Author)</td>
                    @* @{ var author = item.Author; }
                    <td>@(item.DetectedAuther != author ? "×" : "◯") @item.DetectedAuther</td> *@
                    @* <td><MudText Typo="Typo.caption" Style="white-space: pre-line;">@item.DetectedExplanation</MudText></td> *@
                    <td>@item.Site</td>
                    @* @{ var site = item.Site; }
                    <td>@(item.DetectedSite != site ? "×" : "◯") @item.DetectedSite</td> *@
                    <td>@item.NumberOfSheets</td>
                    <td>@(updates.Count != item.NumberOfSheets ? $"×{updates.Count}" : "") @(string.Join (", ", updates.ConvertAll (d => $"{d.ToShortDateString ()} {d.ToShortTimeString ()}")))</td>
                </tr>
            }
        }
    </MudSimpleTable>
} else {
    <MudText>No items found.</MudText>
}

@code {
    /// <summary>着目中の書籍</summary>
    [CascadingParameter (Name = "CurrentBookId")] protected long CurrentBookId { get; set; } = 0;
    /// <summary>着目中の書籍設定</summary>
    [CascadingParameter (Name = "SetCurrentBookId")] protected EventCallback<long> SetCurrentBookId { get; set; }

    /// <summary>遅延初期化</summary>
    protected override async Task OnAfterRenderAsync (bool firstRender) {
        await base.OnAfterRenderAsync (firstRender);
        if (firstRender && items?.Count > 0) {
            await SetCurrentBookId.InvokeAsync (items [0].Id);
        }
    }

}
